name: Update Driver Versions

on:
  schedule:
    # æ¯å¤©UTCæ—¶é—´02:00è¿è¡Œ (åŒ—äº¬æ—¶é—´10:00)
    - cron: '0 2 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

permissions:
  contents: write
  pull-requests: write

jobs:
  update-versions:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'

      - name: Update driver versions
        id: update-versions
        run: |
          node scripts/update-driver-versions.cjs

      - name: Check for changes
        id: changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
          fi

      - name: Create Pull Request
        if: steps.changes.outputs.has_changes == 'true'
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          commit-message: 'ðŸ¤– è‡ªåŠ¨æ›´æ–°é©±åŠ¨ç‰ˆæœ¬ä¿¡æ¯'
          title: 'ðŸ¤– é©±åŠ¨ç‰ˆæœ¬è‡ªåŠ¨æ›´æ–°'
          body: |
            ## ðŸ¤– è‡ªåŠ¨æ›´æ–°é©±åŠ¨ç‰ˆæœ¬ä¿¡æ¯
            
            æ­¤PRç”±GitHub Actionsè‡ªåŠ¨åˆ›å»ºï¼ŒåŒ…å«ä»¥ä¸‹æ›´æ–°ï¼š
            
            ### æ›´æ–°å†…å®¹
            - æ£€æŸ¥äº†æ‰€æœ‰é©±åŠ¨çš„GitHubä»“åº“
            - è‡ªåŠ¨æ›´æ–°äº†æœ‰æ–°ç‰ˆæœ¬çš„é©±åŠ¨ä¿¡æ¯
            - æ›´æ–°äº†ç‰ˆæœ¬å·ã€å‘å¸ƒæ—¥æœŸã€ä¸‹è½½é“¾æŽ¥ç­‰ä¿¡æ¯
            
            ### æ›´æ–°ç»Ÿè®¡
            - æ›´æ–°æ–‡ä»¶æ•°é‡: ${{ steps.update-versions.outputs.update_count || 'æœªçŸ¥' }}
            - æ£€æŸ¥æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")
            
            ### æ³¨æ„äº‹é¡¹
            - è¯·ä»”ç»†æ£€æŸ¥æ›´æ–°çš„ç‰ˆæœ¬ä¿¡æ¯æ˜¯å¦æ­£ç¡®
            - ç¡®è®¤æ–°ç‰ˆæœ¬ä¸ŽçŽ°æœ‰é…ç½®çš„å…¼å®¹æ€§
            - å¦‚æœ‰é—®é¢˜è¯·åŠæ—¶ä¿®æ­£æˆ–å…³é—­æ­¤PR
            
            ---
            *æ­¤PRç”± [update-driver-versions.yml](.github/workflows/update-driver-versions.yml) å·¥ä½œæµè‡ªåŠ¨åˆ›å»º*
          branch: auto-update-driver-versions
          delete-branch: true
          labels: |
            automated
            driver-update
            dependencies

      - name: Summary
        run: |
          echo "## ðŸ¤– é©±åŠ¨ç‰ˆæœ¬æ£€æŸ¥å®Œæˆ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- æ£€æŸ¥æ—¶é—´: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- æ˜¯å¦æœ‰æ›´æ–°: ${{ steps.changes.outputs.has_changes }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.changes.outputs.has_changes }}" = "true" ]; then
            echo "- å·²åˆ›å»ºPRè¿›è¡Œç‰ˆæœ¬æ›´æ–°" >> $GITHUB_STEP_SUMMARY
          else
            echo "- æ‰€æœ‰é©±åŠ¨å‡ä¸ºæœ€æ–°ç‰ˆæœ¬" >> $GITHUB_STEP_SUMMARY
          fi